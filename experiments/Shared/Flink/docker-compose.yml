---
version: '2'

services:

# Flink jobmanager
  jobmanager:
    restart: always
    image: flink:1.5.3-alpine
    expose:
      - "6123"
    networks: ['flink']
    ports:
      - "8081:8081"
    command: jobmanager
    environment:
      - JOB_MANAGER_RPC_ADDRESS=jobmanager

#Flink taskmanager
  taskmanager:
    restart: always
    image: flink:1.5.3-alpine
    volumes:
      - "./config/logback.xml:/opt/flink/conf/logback-console.xml"
    expose:
      - "6121"
      - "6122"
    networks: ['flink']
    depends_on:
      - jobmanager
    command: taskmanager
    links:
      - "jobmanager:jobmanager"
    environment:
      - JOB_MANAGER_RPC_ADDRESS=jobmanager
      - TASK_MANAGER_NUMBER_OF_TASK_SLOTS=2


  logspout:
    #Using the prebuilt image because it takes very long to build
    image: nvankaam/logspout
    volumes:
      - '/var/run/docker.sock:/tmp/docker.sock'
    environment:
      ROUTE_URIS: logstash://logstash:5000
      LOGSTASH_TAGS: docker-elk

    restart: on-failure


networks: {flink: {}}